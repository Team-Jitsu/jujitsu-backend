name: Build and Deploy Spring Boot

on:
  push:
    branches: [ main ]

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build with Maven (skip tests)
        run: mvn clean package -DskipTests

      # target/ 디렉토리에 application.properties 생성
      - name: Create application.properties
        run: |
          cat > target/application.properties <<EOL
          spring.application.name=platform
          spring.profiles.active=${SPRING_PROFILES_ACTIVE:-dev}
          spring.datasource.url=jdbc:mysql://localhost:3306/fightingkorea?serverTimezone=UTC&useSSL=false&allowPublicKeyRetrieval=true
          spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
          spring.datasource.hikari.minimum-idle=5
          spring.datasource.hikari.maximum-pool-size=30
          spring.datasource.hikari.idle-timeout=30000
          spring.datasource.hikari.connection-timeout=30000
          spring.datasource.hikari.max-lifetime=1800000
          spring.jpa.open-in-view=true
          spring.jpa.properties.hibernate.show_sql=true
          spring.jpa.properties.hibernate.format_sql=true
          spring.jpa.properties.hibernate.use_sql_comments=true
          spring.jpa.properties.hibernate.hbm2ddl.auto=update
          spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQL8Dialect
          springdoc.api-docs.path=/api-docs
          springdoc.swagger-ui.path=/swagger-ui.html
          springdoc.swagger-ui.url=/api-docs
          springdoc.swagger-ui.operations-sorter=method
          app.s3.presignTtlSeconds=3600
          spring.servlet.multipart.max-file-size=2GB
          spring.servlet.multipart.max-request-size=2GB
          logging.level.root=INFO
          logging.level.org.springframework=INFO
          logging.level.org.hibernate=INFO
          logging.level.com.zaxxer.hikari=INFO
          spring.jpa.show-sql=false
          spring.datasource.username=${{ secrets.DB_USERNAME }}
          spring.datasource.password=${{ secrets.DB_PASSWORD }}
          app.s3.basePath=${{ secrets.S3_BASE_PATH }}
          app.s3.bucket=${{ secrets.S3_BUCKET_NAME }}
          jwt.access.secret.key=${{ secrets.JWT_ACCESS_SECRET }}
          jwt.refresh.secret.key=${{ secrets.JWT_REFRESH_SECRET }}
          toss.payments.secret.key=${{ secrets.TOSS_PAYMENTS_SECRET_KEY }}
          cloud.aws.credentials.access-key=${{AWS_ACCESS_KEY_ID}}
          cloud.aws.credentials.secret-key=${{AWS_SECRET_ACCESS_KEY}}
          EOL

      # jar + application.properties만 복사
      - name: Copy JAR and properties to server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ubuntu
          key: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}
          port: 22
          source: "target/*.jar,target/application.properties"
          target: /home/ubuntu/app
